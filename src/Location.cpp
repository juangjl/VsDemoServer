/**
 * @file Location.cpp 
 * @brief Location function for location
 * @version $Revision$
 * @author JL Juang <jl_juang@vsigntek.com>
 * @note Copyright (c) 2025,  VitalSigns Technology Co., LTD., all rights reserved.
 * @note
*/
#include "Global.h"

LocationDataType LocationData;

void LocationGpsDataPrint(JDevice * pDevice)
{
  char msg[256];
  JTM jtm;
  JTM * pJtm = &jtm;
  time_t tUtc = 0;

	JINT iDid = pDevice->dwDID;

  ///----------------------------------------------------------------///
  /// GPS
  ///----------------------------------------------------------------///    
  sprintf(msg, "\t\t [LOC] GPS-FIXED = %d\r\n", LocationData.iGpsFixed);
  DBG_PRINTF(iDid, msg);


  tUtc = LocationData.dwGpsUtc;
  JTMGmtTimeGet(pJtm, tUtc);
  sprintf(msg, "\t\t [LOC] GPS-UTC-NOW = %d, TIME = %04d/%02d/%02d-%02d:%02d:%02d\r\n", 
            LocationData.dwGpsUtc,
            pJtm->iYear, pJtm->iMonth, pJtm->iDay,            
            pJtm->iHour, pJtm->iMin, pJtm->iSec);
  DBG_PRINTF(iDid, msg);

  tUtc  = LocationData.dwGpsUtcFixed;
  JTMGmtTimeGet(pJtm, tUtc);
  sprintf(msg, "\t\t [LOC] GPS-UTC-FIXED = %d, TIME = %04d/%02d/%02d-%02d:%02d:%02d\r\n", 
            LocationData.dwGpsUtcFixed,
            pJtm->iYear, pJtm->iMonth, pJtm->iDay,            
            pJtm->iHour, pJtm->iMin, pJtm->iSec);
  DBG_PRINTF(iDid, msg);

  sprintf(msg, "\t\t [LOC] GPS-LAT = %0.6f\r\n", LocationData.fGpsLat);
  DBG_PRINTF(iDid, msg);

  sprintf(msg, "\t\t [LOC] GPS-LON = %0.6f\r\n", LocationData.fGpsLon);
  DBG_PRINTF(iDid, msg);

  sprintf(msg, "\t\t [LOC] GPS-ALT = %0.1f\r\n", LocationData.fGpsAlt);
  DBG_PRINTF(iDid, msg);

  sprintf(msg, "\t\t [LOC] GPS-VEL = %0.1f\r\n", LocationData.fGpsVel);
  DBG_PRINTF(iDid, msg);

  sprintf(msg, "\t\t [LOC] GPS-COG = %0.1f\r\n", LocationData.fGpsCog);
  DBG_PRINTF(iDid, msg);

  ///----------------------------------------------------------------///
  /// AGPS
  ///----------------------------------------------------------------///
  sprintf(msg, "\t\t [LOC] AGPS-FIXED = %d\r\n", LocationData.iGpsFixed);
  DBG_PRINTF(iDid, msg);


  tUtc  = LocationData.dwAGpsUtc;
  JTMGmtTimeGet(pJtm, tUtc);
  sprintf(msg, "\t\t [LOC] AGPS-UTC-NOW = %d, TIME = %04d/%02d/%02d-%02d:%02d:%02d\r\n", 
            LocationData.dwAGpsUtc,
            pJtm->iYear, pJtm->iMonth, pJtm->iDay,            
            pJtm->iHour, pJtm->iMin, pJtm->iSec);
  DBG_PRINTF(iDid, msg);


  tUtc  = LocationData.dwAGpsUtcFixed;
  JTMGmtTimeGet(pJtm, tUtc);
  sprintf(msg, "\t\t [LOC] AGPS-UTC-FIXED = %d, TIME = %04d/%02d/%02d-%02d:%02d:%02d\r\n", 
            LocationData.dwAGpsUtcFixed,
            pJtm->iYear, pJtm->iMonth, pJtm->iDay,            
            pJtm->iHour, pJtm->iMin, pJtm->iSec);
  DBG_PRINTF(iDid, msg);

  sprintf(msg, "\t\t [LOC] AGPS-LAT = %0.6f\r\n", LocationData.fAGpsLat);
  DBG_PRINTF(iDid, msg);

  sprintf(msg, "\t\t [LOC] AGPS-LON = %0.6f\r\n", LocationData.fAGpsLon);
  DBG_PRINTF(iDid, msg);

  sprintf(msg, "\t\t [LOC] AGPS-ALT = %0.1f\r\n", LocationData.fAGpsAlt);
  DBG_PRINTF(iDid, msg);

  sprintf(msg, "\t\t [LOC] AGPS-ERR = %0.1f\r\n", LocationData.fAGpsError);
  DBG_PRINTF(iDid, msg);
}

void LocationInfoHeaderWrite(FILE *fp)
{
  char msg[256];

  if(fp == NULL)
  {  
    return;
  } 

  ///------------------------------------------------------------------------------------------------///
  ///
  /// Header Write
  ///
  ///------------------------------------------------------------------------------------------------///
      
  ///----------------------------------------------------------------///
  /// #00 : YEAR
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "YEAR,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #01 : MONTH
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "MONTH,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #02 : DAY
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "DAY,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #03 :  HOUR 
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "HOUR,");  
  fprintf(fp,"%s", msg);
  
  ///----------------------------------------------------------------///
  /// #04 : MIN
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "MIN,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #05 : SEC
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "SEC,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #06 : GPS_UTC
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "GPS_UTC,");  
  fprintf(fp,"%s", msg);
  
  ///----------------------------------------------------------------///
  /// #07 : GPS_FIXED
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "GPS_FIXED,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #08 : GPS_UTC_FIXED 
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "GPS_UTC_FIXED,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #09 : GPS_LAT
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "GPS_LAT,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #10 :  GPS_LON
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "GPS_LON,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #11 : GPS_ALT
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "GPS_ALT,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #12 : GPS_VEL
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "GPS_VEL,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #13 :  GPS_AZI
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "GPS_AZI,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #14 : AGPS_UTC
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "AGPS_UTC,");  
  fprintf(fp,"%s", msg);
  
  ///----------------------------------------------------------------///
  /// #15 :  AGPS_FIXED
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "AGPS_FIXED,");  
  fprintf(fp,"%s", msg);
    
  ///----------------------------------------------------------------///
  /// #16 :  AGPS_UTC_FIXED
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "AGPS_UTC_FIXED,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #17 : AGPS_LAT   
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "AGPS_LAT,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #18 : AGPS_LON
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "AGPS_LON,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #19 : AGPS_ALT
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "AGPS_ALT,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #20 : AGPS_ERR
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "AGPS_ERR,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #21 : DUMMY0
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "DUMMY0,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #22: DUMMY1
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "DUMMY1,");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #23 :  DUMMY2
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "DUMMY2");  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// End of labels
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "\r\n");  
  fprintf(fp,"%s", msg);

}

void LocationInfoDataWrite(FILE *fp)
{
  JTM jtm;
  JTM * pJtm = &jtm;  
  char msg[256];    
  time_t tNow = time(NULL);

  LocationDataType *pLocationData = &LocationData; 

  if(fp == NULL)
  {  
    return;
  }

  JTMGmtTimeGet(pJtm, tNow);

  ///----------------------------------------------------------------///
  /// #00 : YEAR
  ///----------------------------------------------------------------///  
  sprintf(msg, "%04d,",  pJtm->iYear);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #01 : MONTH
  ///----------------------------------------------------------------///  
  sprintf(msg, "%02d,",  pJtm->iMonth);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #02 : DAY
  ///----------------------------------------------------------------///  
  sprintf(msg, "%02d,",  pJtm->iDay);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #03 :  HOUR 
  ///----------------------------------------------------------------///  
  sprintf(msg, "%02d,",  pJtm->iHour);  
  fprintf(fp,"%s", msg);
  
  ///----------------------------------------------------------------///
  /// #04 : MIN
  ///----------------------------------------------------------------///  
  sprintf(msg, "%02d,",  pJtm->iMin);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #05 : SEC
  ///----------------------------------------------------------------///  
  sprintf(msg, "%02d,",  pJtm->iSec);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #06 : GPS_UTC
  ///----------------------------------------------------------------///  
  sprintf(msg, "%d,",  pLocationData->dwGpsUtc);  
  fprintf(fp,"%s", msg);
  
  ///----------------------------------------------------------------///
  /// #07 : GPS_FIXED
  ///----------------------------------------------------------------///  
  sprintf(msg, "%d,",  pLocationData->iGpsFixed);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #08 : GPS_UTC_FIXED 
  ///----------------------------------------------------------------///  
  sprintf(msg, "%d,",  pLocationData->dwAGpsUtcFixed);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #09 : GPS_LAT
  ///----------------------------------------------------------------///  
  sprintf(msg, "%0.6f,",  pLocationData->fGpsLat);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #10 :  GPS_LON
  ///----------------------------------------------------------------///  
  sprintf(msg, "%0.6f,",  pLocationData->fGpsLon);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #11 : GPS_ALT
  ///----------------------------------------------------------------///  
  sprintf(msg, "%0.1f,",  pLocationData->fGpsAlt);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #12 : GPS_VEL
  ///----------------------------------------------------------------///  
  sprintf(msg, "%0.3f,",  pLocationData->fGpsVel);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #13 :  GPS_AZI
  ///----------------------------------------------------------------///  
  sprintf(msg, "%0.3f,",  pLocationData->fGpsCog);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #14 : AGPS_UTC
  ///----------------------------------------------------------------///  
  sprintf(msg, "%d,",  pLocationData->dwAGpsUtc);  
  fprintf(fp,"%s", msg);
  
  ///----------------------------------------------------------------///
  /// #15 :  AGPS_FIXED
  ///----------------------------------------------------------------///  
  sprintf(msg, "%d,",  pLocationData->iAGpsFixed);  
  fprintf(fp,"%s", msg);
    
  ///----------------------------------------------------------------///
  /// #16 :  AGPS_UTC_FIXED
  ///----------------------------------------------------------------///  
  sprintf(msg, "%d,",  pLocationData->dwAGpsUtcFixed);
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #17 : AGPS_LAT   
  ///----------------------------------------------------------------///  
  sprintf(msg, "%0.6f,",  pLocationData->fAGpsLat);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #18 : AGPS_LON
  ///----------------------------------------------------------------///  
  sprintf(msg, "%0.6f,",  pLocationData->fAGpsLon);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #19 : AGPS_ALT
  ///----------------------------------------------------------------///  
  sprintf(msg, "%0.0f,",  pLocationData->fAGpsAlt);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #20 : AGPS_ERR
  ///----------------------------------------------------------------///  
  sprintf(msg, "%0.0f,",  pLocationData->fAGpsError);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #21 : DUMMY0
  ///----------------------------------------------------------------///  
  sprintf(msg, "%d,",  pLocationData->iDummy0);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #22: DUMMY1
  ///----------------------------------------------------------------///  
  sprintf(msg, "%d,",  pLocationData->iDummy1);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// #23 :  DUMMY2
  ///----------------------------------------------------------------///  
  sprintf(msg, "%d,",  pLocationData->iDummy2);  
  fprintf(fp,"%s", msg);

  ///----------------------------------------------------------------///
  /// End of values
  ///----------------------------------------------------------------///
  sprintf(msg, "%s", "\r\n");  
  fprintf(fp,"%s", msg);  
}

void LocationInfoFileWrite(JUINT dwDID, char * strFileName, JBOOL bAppend)
{      
  char strFmt[16];   
  FILE *fp  = NULL;
  JBOOL bExisted = FALSE;

  ///----------------------------------------------------------------///
  /// Append data or create new file check
  ///----------------------------------------------------------------///
  if(bAppend == TRUE)
  {
    sprintf(strFmt ,"%s", "a+");
  }
  else
  {
    sprintf(strFmt ,"%s", "w+");
  }  

  ///----------------------------------------------------------------///
  /// File existed check
  ///----------------------------------------------------------------///
  bExisted = UtilFileExisted(strFileName);

  ///----------------------------------------------------------------///
  /// File open
  ///----------------------------------------------------------------///  
  fp = fopen(strFileName, strFmt);

  if(fp == NULL)
  {
    DBG_PRINTF(dwDID, "\t [LOC][ERROR] loc info file create fail :  %s\r\n",strFileName);
    return;
  } 
  
  ///------------------------------------------------------------------------------------------------///  
  /// Header Write  
  ///------------------------------------------------------------------------------------------------///  
  if((bExisted == FALSE) || (bAppend == FALSE))
  {
    LocationInfoHeaderWrite(fp);
  }  

  ///------------------------------------------------------------------------------------------------///  
  /// Data Write  
  ///------------------------------------------------------------------------------------------------///
  LocationInfoDataWrite(fp);
    
  fclose(fp);
}
